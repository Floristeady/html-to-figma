# Team Deployment Plan - HTML to Figma

**Date**: January 28, 2026
**Status**: Planning
**Scope**: Simple team deployment with remote server

## Objective

Enable the internal team (max 4 users) to use the **HTML-to-Figma** plugin with MCP integration (Cursor, Claude Desktop, Claude Code) with:
- One-time installation (~5 minutes)
- No technical knowledge required
- No need to clone or run this project

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    RENDER SERVER                             │
│              (https://html-to-figma.onrender.com)           │
│                                                              │
│   ┌─────────────┐          ┌─────────────────────┐          │
│   │ MCP Server  │◄────────►│ SSE Server          │          │
│   │ (HTTP API)  │          │ (real-time events)  │          │
│   └─────────────┘          └─────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
          ▲                            ▲
          │                            │
    ┌─────┴─────┐                ┌─────┴─────┐
    │           │                │           │
┌───┴───┐   ┌───┴───┐        ┌───┴───┐   ┌───┴───┐
│ User1 │   │ User2 │        │ User1 │   │ User2 │
│Claude │   │Cursor │        │Figma  │   │Figma  │
│ Code  │   │       │        │Plugin │   │Plugin │
└───────┘   └───────┘        └───────┘   └───────┘
```

### Usage flow:

**First time setup (once):**
1. User opens Figma plugin
2. Plugin auto-generates a session ID and displays it: `user_7f3a2b`
3. User clicks "Copy ID" and pastes it in their MCP config
4. Done - never touch this again

**Daily use:**
1. User opens Figma plugin (shows "Connected as: user_7f3a2b")
2. User writes in Claude Code/Cursor: "Convert this HTML to Figma"
3. MCP sends HTML + session ID to Render server
4. Server routes to the correct Figma plugin
5. Design appears on canvas

---

## Work Plan

### PHASE 1: Centralized Server on Render
**Priority**: High

#### Objective
Replace localhost with a Render server accessible to the team.

#### Tasks

- [ ] **1.1** Prepare server for production
  - Add environment variable `SERVER_URL`
  - Support HTTPS (Render provides this)
  - Configure CORS for Figma plugin
  - Add basic authentication (team API key)

- [ ] **1.2** Implement session/user identification
  - Plugin generates unique session ID on first open (stored locally)
  - Plugin shows ID in UI with "Copy" button
  - MCP reads ID from env variable `FIGMA_SESSION_ID`
  - Server routes HTML to plugin with matching session ID

- [ ] **1.3** Deploy to Render
  - Create Render account/project
  - Configure environment variables
  - Deploy SSE + API server
  - Test connection

- [ ] **1.4** Update MCP for remote server
  - Connect to Render URL instead of localhost
  - Pass session ID with requests
  - Handle reconnection

---

### PHASE 2: Distribution Setup
**Priority**: High

#### Objective
Prepare everything for easy team installation.

#### Tasks

- [ ] **2.1** Prepare MCP package for GitHub distribution
  - Ensure package.json has correct "bin" entry
  - Test installation via `npx github:your-org/html-to-figma-mcp`
  - Add clear README with usage instructions

- [ ] **2.2** Create production plugin build
  - Plugin pre-configured with Render server URL
  - Build production version
  - Create .zip for distribution

- [ ] **2.3** Create installation guide
  - Step-by-step with screenshots
  - Configurations ready to copy/paste
  - Troubleshooting section

---

### PHASE 3: Simplify Installation
**Priority**: High

#### Objective
Installation in less than 5 minutes.

#### Tasks

- [ ] **3.1** Test complete flow
  - Test with Cursor
  - Test with Claude Desktop
  - Test with Claude Code
  - Verify each user receives only their messages

- [ ] **3.2** Create team onboarding document
  - Simple PDF or Notion page
  - Video walkthrough (optional)

---

## Configurations

### Claude Code / Cursor MCP Config
```json
{
  "mcpServers": {
    "html-to-figma": {
      "command": "npx",
      "args": ["-y", "github:your-org/html-to-figma"],
      "env": {
        "FIGMA_SERVER_URL": "https://html-to-figma.onrender.com",
        "FIGMA_SESSION_ID": "user_7f3a2b",
        "API_KEY": "team-shared-key"
      }
    }
  }
}
```
*Note: `FIGMA_SESSION_ID` comes from the plugin UI (copy button)*

### Figma Plugin
Pre-configured with server URL. Shows:
- Session ID with "Copy" button (for first-time setup)
- Connection status: "Connected as: user_7f3a2b"

---

## Decisions Made

- **Render plan**: Free tier (cold starts ~30s acceptable for now, upgrade if team grows)
- **Authentication**: Single shared API key for the team
- **Session ID**: Auto-generated by plugin, shown in UI with "Copy" button. User copies once to MCP config.
- **Distribution**: GitHub public repo (this same repo)

---

## Success Metrics

- [ ] Complete installation in less than 5 minutes
- [ ] Works with Cursor, Claude Desktop, and Claude Code
- [ ] Each user receives only their own HTML
- [ ] Stable connection (auto-reconnect if dropped)
- [ ] No technical support needed after initial setup

---

---

## Detailed Step-by-Step Execution Plan

Based on current code analysis. Execute in order.

### STEP 1: Add Session ID to Plugin
**Files**: `src/ui.html`, `src/code.ts`

- [ ] 1.1 Generate unique session ID on first plugin open
  - Use `crypto.randomUUID()` or similar
  - Store in `figma.clientStorage` (persists across sessions)
  - Format: `user_` + 8 random chars (e.g., `user_7f3a2b1c`)

- [ ] 1.2 Add Session ID display in plugin UI
  - Show ID prominently: "Your Session ID: user_7f3a2b1c"
  - Add "Copy" button next to it
  - Show connection status: "Connected as: user_7f3a2b1c"

- [ ] 1.3 Include session ID in SSE connection
  - Modify EventSource URL: `/mcp-stream?sessionId=user_7f3a2b1c`
  - Send session ID with every message to server

---

### STEP 2: Update SSE Server for Multi-User
**File**: `sse-server.js`

- [ ] 2.1 Track clients by session ID
  - Change `sseConnections` from array to Map: `sessionId → connection`
  - Parse sessionId from query params on connect
  - Log: "Client connected: user_7f3a2b1c"

- [ ] 2.2 Route messages to specific client
  - Modify `/mcp-trigger` to accept `sessionId` in body
  - Only send HTML to matching session ID (not broadcast)
  - Return error if session ID not connected

- [ ] 2.3 Add environment variables
  ```javascript
  const PORT = process.env.PORT || 3003;  // Render uses PORT
  const API_KEY = process.env.API_KEY || 'dev-key';
  const ALLOWED_ORIGINS = process.env.ALLOWED_ORIGINS || '*';
  ```

- [ ] 2.4 Add API key authentication
  - Check `Authorization: Bearer <API_KEY>` header on `/mcp-trigger`
  - Return 401 if invalid

- [ ] 2.5 Configure CORS for production
  - Allow requests from Figma plugin origin
  - Handle preflight OPTIONS requests

---

### STEP 3: Update MCP Server
**File**: `mcp-server.js`

- [ ] 3.1 Read session ID from environment
  ```javascript
  const SESSION_ID = process.env.FIGMA_SESSION_ID;
  const SERVER_URL = process.env.FIGMA_SERVER_URL || 'http://localhost:3003';
  const API_KEY = process.env.API_KEY || 'dev-key';
  ```

- [ ] 3.2 Include session ID in trigger request
  - Add `sessionId` to POST body
  - Add `Authorization` header with API key

- [ ] 3.3 Validate configuration on startup
  - Warn if SESSION_ID is missing
  - Log server URL being used

---

### STEP 4: Deploy to Render
**Platform**: render.com (Free tier)

- [ ] 4.1 Create Render account and project
  - Connect GitHub repo
  - Select "Web Service"
  - Set build command: `npm install`
  - Set start command: `node sse-server.js`

- [ ] 4.2 Configure environment variables in Render
  ```
  PORT=10000 (Render assigns this)
  API_KEY=your-team-secret-key
  ALLOWED_ORIGINS=*
  NODE_ENV=production
  ```

- [ ] 4.3 Deploy and get URL
  - Note the URL: `https://html-to-figma-XXXX.onrender.com`
  - Test with curl: `curl https://your-url.onrender.com/mcp-status`

- [ ] 4.4 Test SSE connection
  - Open in browser: `https://your-url.onrender.com/mcp-stream?sessionId=test`
  - Should see heartbeat messages

---

### STEP 5: Build Production Plugin
**Files**: `src/ui.html`, build scripts

- [ ] 5.1 Add environment-based server URL
  - For dev: `http://localhost:3003`
  - For prod: `https://html-to-figma-XXXX.onrender.com`
  - Use build flag or hardcode for team distribution

- [ ] 5.2 Build production version
  ```bash
  npm run build
  ```

- [ ] 5.3 Create distribution package
  - Zip: `manifest.json`, `code.js`, `ui.html`
  - Name: `html-to-figma-plugin-prod.zip`

---

### STEP 6: Prepare GitHub Distribution for MCP
**Files**: `package.json`, `mcp-server.js`

- [ ] 6.1 Ensure package.json has bin entry
  ```json
  {
    "name": "html-to-figma-mcp",
    "bin": {
      "html-to-figma-mcp": "./mcp-server.js"
    }
  }
  ```

- [ ] 6.2 Add shebang to mcp-server.js
  ```javascript
  #!/usr/bin/env node
  ```

- [ ] 6.3 Test local npx installation
  ```bash
  npx github:your-username/html-to-figma
  ```

---

### STEP 7: Create Team Installation Guide
**File**: `docs/INSTALLATION_GUIDE.md`

- [ ] 7.1 Write Figma plugin installation steps
  - Download zip
  - Import in Figma
  - Copy session ID

- [ ] 7.2 Write MCP configuration for each client
  - Claude Code config
  - Cursor config
  - Claude Desktop config

- [ ] 7.3 Add troubleshooting section
  - Common errors and solutions
  - How to verify connection

---

### STEP 8: End-to-End Testing
**Goal**: Verify complete flow works

- [ ] 8.1 Test with your own setup
  - Fresh plugin install
  - Copy session ID to MCP config
  - Send HTML from Claude Code
  - Verify design appears in Figma

- [ ] 8.2 Test with one team member
  - Have them follow installation guide
  - Verify they receive only their HTML (not yours)

- [ ] 8.3 Test edge cases
  - Multiple users sending simultaneously
  - Server cold start (after 15 min idle)
  - Reconnection after disconnect

---

## Current Code Status

| Component | File | Status | Changes Needed |
|-----------|------|--------|----------------|
| SSE Server | `sse-server.js` | ✅ Works locally | Add session routing, auth, env vars |
| MCP Server | `mcp-server.js` | ✅ Works locally | Add session ID, remote URL support |
| Plugin | `src/code.ts` + `src/ui.html` | ✅ Works locally | Add session ID UI, remote URL |
| Config | `config/server-config.js` | ✅ Exists | Add production settings |

---

## Quick Reference: Final Configuration

### User's MCP Config (Claude Code/Cursor)
```json
{
  "mcpServers": {
    "html-to-figma": {
      "command": "npx",
      "args": ["-y", "github:figmaflor/html-to-figma"],
      "env": {
        "FIGMA_SERVER_URL": "https://html-to-figma-XXXX.onrender.com",
        "FIGMA_SESSION_ID": "user_XXXXXXXX",
        "API_KEY": "team-shared-key"
      }
    }
  }
}
```

### Render Environment Variables
```
PORT=10000
API_KEY=team-shared-key
ALLOWED_ORIGINS=*
NODE_ENV=production
```

---

**Last updated**: January 28, 2026
